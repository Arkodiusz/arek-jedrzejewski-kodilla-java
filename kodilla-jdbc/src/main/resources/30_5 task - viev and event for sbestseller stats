CREATE TABLE STATS (
    STAT_ID INT(11) AUTO_INCREMENT PRIMARY KEY,
    STAT_DATE DATETIME NOT NULL,
    STAT VARCHAR(20) NOT NULL,
    VALUE INT(11) NOT NULL
);

CREATE VIEW BESTSELLERS_COUNT AS
SELECT COUNT(BOOK_ID)
FROM BOOKS
WHERE BESTSELLER = 1;

DELIMITER $$

DROP PROCEDURE IF EXISTS UpdateStats;
CREATE PROCEDURE UpdateStats()
BEGIN
    DECLARE BEST_COUNT INT;
    CALL UpdateBestsellers();
    SELECT * FROM BESTSELLERS_COUNT INTO BEST_COUNT;
    INSERT INTO STATS (STAT_DATE, STAT, VALUE)
    VALUES (CURDATE(), 'BESTSELLERS', BEST_COUNT);

END $$

DELIMITER ;

CREATE EVENT UPDATE_SELLERS
    ON SCHEDULE EVERY 1 MINUTE
    DO
    CALL UpdateStats();